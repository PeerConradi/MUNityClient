@page "/sim/run/{id}"

@inject Services.SimulationService simulationService;
@inject Services.ListOfSpeakerService listOfSpeakerService;
@inject NavigationManager navigationManager;

@layout MUNityClient.Shared.EmptyLayout;

@*
    Der SimulationsRunner ist die "Schirmkomponente" über den Einzelnen Simulations Komponenten.
    An dieser Stelle wird eine Verbindung zum Server initialisiert und alle zum Start erforderlichen Daten
    werden einmal geladen.

    Zudem wird der Socket initialisiert und an die Sub-Komponenten welche diesen ggf. brauchen weiter gereicht.

    Diese Komponente soll auch das Basis Layout für das Simulationsfenster stellen.
*@


@if (_simulation != null && _auth != null)
{
    <div class="row">
        <div class="col-12">
            <MUNityClient.Shared.VirtualCommittee.SimulationVotingBanner SimulationSocket="@_socket" />
        </div>
    </div>

    <div class="row col-12 m-0 p-0">

        @* Benutzerliste *@
        <div class="col-lg-3 col-md-12 col-sm-12">
            <MUNityClient.Shared.VirtualCommittee.UserList.SimulationLiveUserList Users="@_users" Roles="_simulation.Roles" SocketHandler="@_socket" />
        </div>

        @* Hauptinhalt *@
        <div class="col-lg-5 col-md-12 col-sm-12">

        </div>

        @* Ansicht für die Redeliste *@
        <div class="col-md-12 col-lg-4 col-sm-12">
            <div class="row">
                <div class="card col-12">
                    <div class="card-body">
                        <span>Aktueller Status</span>
                    </div>
                </div>
            </div>
            <div class="row">
                @if (_listOfSpeakerId == "_loading_")
                {
                    <p>Redeliste wird abgerufen...</p>
                }
                else if (string.IsNullOrEmpty(_listOfSpeakerId))
                {
                    if (_auth.CanCreateRole || _myRole.RoleType == MUNity.Schema.Simulation.SimulationEnums.RoleTypes.Chairman)
                    {
                        <button class="btn btn-success" @onclick="() => InitListOfSpeakers()">Redeliste anlegen</button>
                    }
                    else
                    {
                        <p>Keine Redeliste vorhanden.</p>
                    }
                }
                else
                {
                    <MUNityClient.Shared.Los.LoSReaderComponent ListOfSpeakersId="@_listOfSpeakerId" IsOnline="true"></MUNityClient.Shared.Los.LoSReaderComponent>
                }
            </div>
        </div>
    </div>

    @* Ansicht für die Steuerung *@
    <div class="row m-0 p-0">
        <div class="col-12">
            <MUNityClient.Shared.VirtualCommittee.SimulationControls Me="@_users.FirstOrDefault(n => n.SimulationUserId == _auth.SimulationUserId)"
                                                                     SimulationId="@_simulation.SimulationId"
                                                                     SpeakerlistId="@_listOfSpeakerId"
                                                                     Role="@_myRole"
                                                                     Socket="@_socket"
                                                                     Users="@_users"
                                                                     Roles="@_simulation.Roles"></MUNityClient.Shared.VirtualCommittee.SimulationControls>
        </div>
    </div>
}

@code {
    [Parameter]
    public string Id { get; set; }

    private MUNity.Schema.Simulation.SimulationResponse _simulation;

    private MUNity.Schema.Simulation.SimulationAuthSchema _auth;

    private List<MUNity.Schema.Simulation.IUserItem> _users = new List<MUNity.Schema.Simulation.IUserItem>();

    private Services.SocketHandlers.SimulationSocketHandler _socket;
    private int currentTab = 0;

    private MUNity.Schema.Simulation.SimulationRoleItem _myRole;

    private string _listOfSpeakerId = "_loading_";


    protected override async Task OnInitializedAsync()
    {
        int id = 0;
        if (int.TryParse(Id, out id))
        {
            this._simulation = await simulationService.GetSimulation(id);
            this._simulation.Roles = await simulationService.GetRoles(id);
            this._auth = await simulationService.GetMyAuth(id);

            _socket = await simulationService.Subscribe(id);
            AddHandlers(_socket);
            if (_auth.CanCreateRole)
            {
                var tmpUsers = await simulationService.GetUserSetups(id);
                this._users.AddRange(tmpUsers);
                int roleId = this._users.FirstOrDefault(n => n.SimulationUserId == _auth.SimulationUserId)?.RoleId ?? -2;
                this._myRole = this._simulation.Roles.FirstOrDefault(n => n.SimulationRoleId == roleId);
            }
            else
            {
                var tmpUsers = (await simulationService.GetUsers(id)).ToList();
                this._users.AddRange(tmpUsers);
                int roleId = this._users.FirstOrDefault(n => n.SimulationUserId == _auth.SimulationUserId)?.RoleId ?? -2;
                this._myRole = this._simulation.Roles.FirstOrDefault(n => n.SimulationRoleId == roleId);
            }

            this._listOfSpeakerId = await this.simulationService.GetListOfSpeakerId(id);


            this.StateHasChanged();
        }
    }

    

    private void AddHandlers(Services.SocketHandlers.SimulationSocketHandler socket)
    {
        socket.UserConnected += OnUserConnected;
        socket.UserDisconnected += OnUserDisconnected;
        socket.PhaseChanged += OnPhaseChanged;
    }

    

    private void OnPhaseChanged(int sender, MUNity.Schema.Simulation.SimulationEnums.GamePhases phase)
    {
        if (phase == MUNity.Schema.Simulation.SimulationEnums.GamePhases.Lobby)
        {
            navigationManager.NavigateTo($"/sim/lobby/{Id}");
        }
    }

    private void OnUserConnected(int sender, MUNity.Schema.Simulation.SimulationUserItem user)
    {
        if (_users != null)
        {
            var tmpUser = _users.FirstOrDefault(n => n.SimulationUserId == user.SimulationUserId);
            if (tmpUser != null)
            {
                tmpUser.IsOnline = true;
                tmpUser.DisplayName = user.DisplayName;
                this.StateHasChanged();
            }
        }
    }

    private void OnUserDisconnected(int sender, MUNity.Schema.Simulation.SimulationUserItem user)
    {
        if (_users != null)
        {
            var tmpUser = _users.FirstOrDefault(n => n.SimulationUserId == user.SimulationUserId);
            if (tmpUser != null)
            {
                tmpUser.IsOnline = false;
                this.StateHasChanged();
            }
        }
    }

    private async void InitListOfSpeakers()
    {
        if (this._simulation != null)
        {
            var list = await this.simulationService.InitListOfSpeakers(this._simulation.SimulationId);
            if (list != null)
            {
                this._listOfSpeakerId = list.ListOfSpeakersId;
                this.StateHasChanged();
            }
        }
    }

}

<style>
    .header-item {
        transition: .3s;
    }

        .header-item:not(.selected-tab):hover {
            background-color: #dedede;
        }

    .selected-tab {
        background-color: #1266F1;
        color: white;
    }
</style>